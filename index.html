<!DOCTYPE html>
<html lang="ro">
<head>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <meta charset="UTF-8" />
  <title>Pontaj – Lunar & Admin (fără QR)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
   :root{
  /* fundal general albastru mai deschis */
  --bg:#152238; 
  --card:#1f2d46; 
  --muted:#7f8ca3; 
  --text:#f5f8ff;

  /* accente */
  --accent:#00c6ff;    /* cyan viu */
  --accent2:#ff4f81;   /* roz */
  
  /* tabele și borduri */
  --thead:#1a3b5f; 
  --thead2:#1976d2;    /* albastru intens */
  --border:#2f4768;
  --wkbg:#1b3550;      /* weekend mai vizibil */

  /* status */
  --ok:#1abc9c; 
  --warn:#f7b32b; 
  --danger:#e74c3c;
}



    *{box-sizing:border-box}
   body {
  margin:0;
  font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
  background: var(--bg);
  color:var(--text);
}

    header{
  display:flex; 
  align-items:center; 
  justify-content:space-between;           /* mutăm logo la dreapta */
  padding:14px 18px;
  background:linear-gradient(90deg, #062a4d 0%, #0d3c75 60%, #1147a5 100%);
  border-bottom:1px solid #0b2e58;
}
    header img{height:36px}
    header h1{
  margin:0; 
  font-size:18px; 
  letter-spacing:.3px;
  color:var(--text);  
    }

header .logo{
  height:36px;
  border-radius:10px;                      /* colțuri rotunjite pentru logo */
  padding:4px;                             /* mic “badge” în jurul imaginii */
  background:rgba(255,255,255,.06);        /* fundal discret */
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 2px 10px rgba(0,0,0,.35);   /* umbră fină */
}
    .tabs{ background:rgba(255,255,255,.04) }

.tab{
  background:#14324a;
  border:1px solid var(--border);
  color:var(--text);
  cursor:pointer;
  padding:6px 10px;         /* puțin mai compact */
  border-radius:10px;
  font-weight:600;
  font-size:12px;
  transition:all .15s ease-in-out;
}
.tab:hover{ 
  transform:translateY(-1px); 
  box-shadow:0 2px 6px rgba(0,0,0,.25);
}
.tab.active{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
  border-color:transparent;
  color:#05121b;
}

/* headere tabel mai vii */
th{ 
  background:linear-gradient(180deg, var(--thead2), #0a3dbd);
  color:#fff; 
  font-weight:700;
}
th.weekend{ background:linear-gradient(180deg, #0e57a8, #0b3b58) }


    .wrap{padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}

    .toolbar{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px
    }
    .left,.right{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    label{font-size:12px;opacity:.85}
    select,input{
      padding:8px 10px;font-size:13px;border-radius:10px;border:1px solid var(--border);
      background:#102338;color:#fff
    }
    .btn{
      padding: 5px 9px;border-radius:8px;border:1px solid var(--border);cursor:pointer;font-weight:600;font-size:12px;transition: all .15s ease-in-out;
    }
    .btn:hover{
      opacity: .95 ;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,.25);
    }
    .btn.primary{background:var(--accent);color:#04121e;border:none}
    .btn.primary:hover{ filter: brightness(.95);}
    .btn.ghost{background:#163555}
    .btn.ghost:hover{filter:brightness(1.1) ;}
    .btn.danger{background:var(--danger);color:#fff;border:none}
    .btn.danger:hover{filter:brightness(.95);}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#102338;border:1px solid #2e3b55;opacity:.9}

    .tab-content{display:none}
    .tab-content.active{display:block}
    .scroll-x{overflow-x:auto}

   table{
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
}

th,td{
  border:1px solid var(--border);
  text-align:center;
}

th{
  position:sticky;
  top:0;
  background:linear-gradient(180deg, var(--thead2), #145ca8);
  color:#fff;
  font-weight:600;
}

td{
  background:#23344d;
}

td.name, th:first-child {
  padding-left: 10px;
  text-align: left;
  min-width: 160px;
}


th.weekend{
  background:linear-gradient(180deg, #1e5f99, #15466e);
}

td.weekend{
  background:var(--wkbg);
}

th,td{
  padding:6px;
  font-size:11px;
}
/* animație fină pe rândurile din tbody */
tbody tr{
  transition: background-color .18s ease, box-shadow .18s ease, transform .18s ease;
}

tbody tr:hover{
  background-color: rgba(255,255,255,0.05); /* discret pe dark */
  box-shadow: 0 2px 10px rgba(0,0,0,0.25);
  transform: translateY(-1px);
}

/* celulele rămân lizibile pe hover */
tbody tr:hover td{
  background-color: transparent !important;
}

/* opțional: highlight foarte fin pe rândul selectat (când dai click) */
tbody tr:active{
  transform: translateY(0);
  box-shadow: 0 1px 6px rgba(0,0,0,0.22);
}

/* respectă utilizatorii care preferă mai puțină mișcare */
@media (prefers-reduced-motion: reduce){
  tbody tr{ transition: none; }
}


    input[type="text"]{
      width:36px;min-width:36px;text-align:center;font-size:10px;
      background:#eaffff;color:#071a22;border:1px solid #9fe9ff;border-radius:6px;padding:2px 3px
    }
    td.weekend {background: var(--wkbg);}

    .total{font-weight:700;background:#112b40}
    .delta-badge{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:999px;font-size:10px;font-weight:700}
    .delta-plus{background:#0e3; color:#041}
    .delta-zero{background:#6aa1; color:#ccd}
    .delta-minus{background:#fc0; color:#440}
    .section-title{font-size:14px;margin:0 0 10px 4px;color:#b7cdf0}

    /* Celule cu coduri speciale CO / N / FP */
    .cod-CO input{ background:#e8f7e8 !important; border-color:#9ed39e !important; color:#0f3d0f !important; }
    .cod-N  input{ background:#ffeaea !important; border-color:#f5a5a5 !important; color:#651010 !important; }
    .cod-FP input{ background:#fff8e6 !important; border-color:#f1d28a !important; color:#5a4100 !important; }

    /* Spinner mic */
    .spinner{width:16px;height:16px;border:2px solid #2c4761;border-top-color:#7fb3ff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
  <h1>Pontaj - Lunar</h1>
  <img class="logo" src="sigla.png" alt="Sigla" />
</header>


  <div class="tabs">
    <button class="tab active" data-tab="lunar">Pontaj Lunar</button>
    <button class="tab" data-tab="admin">Raport & Management</button>
  </div>

  <div class="wrap">

    <!-- ========= PONTAJ LUNAR ========= -->
    <section id="lunar" class="tab-content active">
      <div class="card">
        <h3 class="section-title">Ture</h3>
        <div class="toolbar">
          <div class="left">
            <button class="btn ghost" onclick="switchTura('tura1')">Tura 1</button>
            <button class="btn ghost" onclick="switchTura('tura2')">Tura 2</button>
            <span class="pill">Luna curentă</span>
          </div>
          <div class="right">
            <button class="btn danger" onclick="resetPontaj('all')">Resetează luna (toți)</button>
            <button class="btn ghost" onclick="resetPontaj('vizibil')">Resetează luna (tura vizibilă)</button>
            <button class="btn ghost" onclick="resetPontajAngajat()">Resetează un angajat</button>
          </div>
        </div>

        <div class="scroll-x">
          <table id="tura1">
            <thead><tr id="tura1_head"><th>Nume</th></tr></thead>
            <tbody id="tura1_body"></tbody>
          </table>

          <table id="tura2" style="display:none;margin-top:14px">
            <thead><tr id="tura2_head"><th>Nume</th></tr></thead>
            <tbody id="tura2_body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========= ADMIN ========= -->
    <section id="admin" class="tab-content">
      <div class="card">
        <h3 class="section-title">Raport & Management</h3>

        <div class="toolbar">
          <div class="left" id="filters">
            <label>Luna
              <select id="filtruLuna">
                <option value="">Toate</option>
                <option value="1">Ianuarie</option><option value="2">Februarie</option>
                <option value="3">Martie</option><option value="4">Aprilie</option>
                <option value="5">Mai</option><option value="6">Iunie</option>
                <option value="7">Iulie</option><option value="8">August</option>
                <option value="9">Septembrie</option><option value="10">Octombrie</option>
                <option value="11">Noiembrie</option><option value="12">Decembrie</option>
              </select>
            </label>
            <label>Tura
              <select id="filtruTura">
                <option value="">Toate</option>
                <option value="1">Tura 1</option>
                <option value="2">Tura 2</option>
              </select>
            </label>
            <input id="filtruNume" type="text" placeholder="Caută nume (live)..." />
            <button class="btn ghost" id="resetFiltre">Reset</button>
            <span class="pill" id="statusCount">—</span>
          </div>

          <div class="right">
            <button class="btn ghost" id="reloadBtn"><span class="spinner" style="display:none" id="loadSpin"></span> Reîncarcă</button>
            <button class="btn primary" onclick="exportXLSXAdmin()">Export XLSX (Raport)</button>
            <button class="btn primary" onclick="exportPDFAdmin()">Export PDF (Raport)</button>
          </div>
        </div>

        <h3 class="section-title">Management angajați</h3>
        <div class="toolbar">
          <div class="left">
            <button class="btn primary" onclick="adaugaAngajat()">Adaugă</button>
            <button class="btn ghost" onclick="editeazaAngajat()">Editează</button>
            <button class="btn ghost" onclick="codBareAngajat()">Cod de bare</button>
            <button class="btn danger" onclick="stergeAngajat()">Șterge</button>
          </div>
        </div>

        <div class="scroll-x">
          <table>
            <thead><tr id="admin_head"></tr></thead>
            <tbody id="admin_body"><tr><td>Se încarcă…</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- ========== SCRIPT APLICAȚIE (Firebase + module) ========== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, setDoc, deleteDoc, doc,
      query, where, writeBatch, getDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    // import { ..., getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

window.codBareAngajat = async function () {
  const nume = prompt("Numele complet pentru codul de bare:");
  if (!nume) return;

  const ref = doc(db, "angajati", slug(nume));
  const snap = await getDoc(ref);
  if (!snap.exists()) {
    alert("Angajatul nu există.");
    return;
  }

  const a = snap.data();
  let badge = a.badge;
  if (!badge) {
    badge = genBadge();
    await setDoc(ref, { badge }, { merge: true });
  }
  badge = String(badge).toUpperCase();

  // Deschidem fereastra pop-up
  const w = window.open("", "_blank", "width=420,height=360");
  if (!w) { alert("Permite ferestrele pop-up pentru a vedea/printa codul de bare."); return; }

  // 1) Trimitem DOAR scheletul HTML/CSS (fără <script> în string!)
  w.document.write(`<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Card cod de bare</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body{font-family:Inter,system-ui,Arial;margin:0;padding:20px;background:#f8fafc;color:#0b1320}
    .card{width:360px;border:1px solid #cbd5e1;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    h2{margin:0 0 8px 0;font-size:18px}
    .meta{font-size:13px;color:#334155;margin-bottom:10px}
    .actions{margin-top:12px}
    button{padding:8px 12px;border-radius:8px;border:1px solid #334155;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
    @media print { button{display:none} body{background:#fff} .card{box-shadow:none} }
  </style>
</head>
<body>
  <div class="card">
    <h2>${a.nume || ""}</h2>
    <div class="meta">Tura: ${(a.tura != null ? a.tura : "")} &nbsp;|&nbsp; Cod: <strong>${badge}</strong></div>
    <svg id="barcode"></svg>
    <div class="actions"><button onclick="window.print()">Printează</button></div>
  </div>
</body>
</html>`);
  w.document.close();

  // 2) Injectăm JsBarcode programatic și randăm codul
  const s = w.document.createElement("script");
  s.src = "https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js";
  s.onload = () => {
    // important: accesăm API-ul din contextul ferestrei noi (w)
    w.JsBarcode(w.document.querySelector("#barcode"), badge, {
      format: "CODE128",
      displayValue: true,
      fontSize: 16,
      height: 80,
      margin: 10
    });
  };
  w.document.body.appendChild(s);
};




    // ---------- CONFIG FIREBASE ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAQ35cuycNSMlaQ4RL0JHmN5oDOKXCY-ls",
      authDomain: "pontaj2025.firebaseapp.com",
      projectId: "pontaj2025",
      storageBucket: "pontaj2025.appspot.com",
      messagingSenderId: "732863008010",
      appId: "1:732863008010:web:e2b7ed0220f9fb4bcc3ef3"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const slug = s => s.toLowerCase().trim().replace(/\s+/g,'_').replace(/[^\w_-]/g,'');
    const luniRO = ["Ianuarie","Februarie","Martie","Aprilie","Mai","Iunie","Iulie","August","Septembrie","Octombrie","Noiembrie","Decembrie"];
    const today = new Date();
    const lunaIdx = today.getMonth();   // 0..11
    const lunaNum = lunaIdx + 1;        // 1..12
    const anCurent = today.getFullYear();
    const zileInLuna = new Date(anCurent, lunaIdx + 1, 0).getDate();

    // Generare cod intern (opțional) pentru angajat
    function genBadge(len=8){
      const abc = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // fără 0/O/I/1
      return Array.from({length:len}, ()=> abc[Math.floor(Math.random()*abc.length)]).join('');
    }

    // ---------- TAB SWITCH ----------
    document.querySelectorAll(".tab").forEach(b=>{
      b.addEventListener("click",()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        document.getElementById(b.dataset.tab).classList.add("active");
        if(b.dataset.tab === "admin") incarcaAdmin();
      });
    });

    // ---------- UTIL ----------
    const isWeekend = (y, m0, d) => {
      const w = new Date(y, m0, d).getDay(); // 0=Sun,6=Sat
      return w === 0 || w === 6;
    };
    const debounce = (fn, ms=250) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };

    // Normalizează "hh:mm"; acceptă și "815"/"0815".
    function normalizeTime(raw){
      if(!raw) return null;
      let s = String(raw).trim().toUpperCase();
      if (s === "CO" || s === "N" || s === "FP") return s;

      if (/^\d{3,4}$/.test(s)) {
        if (s.length === 3) s = `0${s}`;
        const h = Number(s.slice(0,2));
        const m = Number(s.slice(2,4));
        return validateAndFormat(h, m);
      }
      const m1 = s.match(/^(\d{1,2})[:\.](\d{1,2})$/);
      if (m1) return validateAndFormat(Number(m1[1]), Number(m1[2]));
      const m2 = s.match(/^(\d{1,2}):(\d{2})$/);
      if (m2) return validateAndFormat(Number(m2[1]), Number(m2[2]));
      return null;
    }

    function validateAndFormat(h, m){
      if (isNaN(h)||isNaN(m)) return null;
      if (h < 0 || m < 0 || m > 59) return null;
      if (h > 24) return null;
      if (h === 24 && m !== 0) return null;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    }

    function styleCellByCode(td, val){
      td.classList.remove("cod-CO","cod-N","cod-FP");
      if (val === "CO") td.classList.add("cod-CO");
      if (val === "N")  td.classList.add("cod-N");
      if (val === "FP") td.classList.add("cod-FP");
    }

    function applyValueToCell(nume, zi, tura, val){
      const sel = `input[data-nume="${CSS.escape(nume)}"][data-zi="${zi}"][data-tura="${tura}"]`;
      const inp = document.querySelector(sel);
      if (!inp) return;
      inp.value = val;
      const td = inp.closest('td');
      styleCellByCode(td, val.trim().toUpperCase());
      const tr = inp.closest('tr');
      if (tr) calcTotalRow(tr);
    }

    async function prefillPontaj(tura){
      const col = collection(db, "pontaj_lunar");
      const q = query(col, where("an","==", anCurent), where("luna","==", lunaNum), where("tura","==", tura));
      const snap = await getDocs(q);
      snap.forEach(dref => {
        const d = dref.data();
        if (Number(d.zi) <= 0) return;
        if (!d.nume || !d.ora) return;
        applyValueToCell(d.nume, d.zi, d.tura, d.ora);
      });
    }

    // ================== PONTAJ LUNAR (Ture) ==================
    function buildHeadLunar(elHead){
      for(let zi=1; zi<=zileInLuna; zi++){
        const th=document.createElement("th");
        th.textContent = zi;
        if (isWeekend(anCurent, lunaIdx, zi)) th.classList.add("weekend");
        elHead.appendChild(th);
      }
      const thT=document.createElement("th");
      thT.textContent="Total ore";
      elHead.appendChild(thT);
    }

    function buildBodyLunar(tbody, listaNume, tura){
      tbody.innerHTML = "";
      listaNume.forEach(nume=>{
        const tr=document.createElement("tr");
        const tdN=document.createElement("td");
        tdN.className="name";
        tdN.textContent=nume;
        tr.appendChild(tdN);

        for(let zi=1; zi<=zileInLuna; zi++){
          const td=document.createElement("td");
          if (isWeekend(anCurent, lunaIdx, zi)) td.classList.add("weekend");

          const inp=document.createElement("input");
          inp.type="text"; inp.placeholder="hh:mm";
          inp.setAttribute("list","coduriPontaj");
          inp.dataset.nume=nume; inp.dataset.zi=zi; inp.dataset.tura=tura;
          inp.setAttribute("pattern","^((?:[01]?\\d|2[0-4]):[0-5]\\d|CO|N|FP)$");
          inp.title = "Format permis: hh:mm (max 24:00) sau CO / N / FP";
          inp.inputMode = "numeric";

          const markCode = (val)=>{
            td.classList.remove("cod-CO","cod-N","cod-FP");
            if (val === "CO") td.classList.add("cod-CO");
            if (val === "N")  td.classList.add("cod-N");
            if (val === "FP") td.classList.add("cod-FP");
          };

          inp.addEventListener("input", ()=> markCode(inp.value.trim().toUpperCase()));
          inp.addEventListener("change", async ()=>{
            const norm = normalizeTime(inp.value);
            if (norm === null) {
              inp.setCustomValidity("Introduceți ore în format hh:mm (max 24:00) sau CO/N/FP");
              inp.reportValidity();
              return;
            }
            inp.setCustomValidity("");
            inp.value = norm;
            markCode(norm);
            calcTotalRow(tr);
            await setPontajFirebase(nume, zi, norm, tura);
          });

          td.appendChild(inp);
          tr.appendChild(td);
        }

        const tdTot=document.createElement("td");
        tdTot.className="total"; tdTot.textContent="0h 0m";
        tr.appendChild(tdTot);

        tbody.appendChild(tr);
      });
    }

    function calcTotalRow(tr){
      const inputs = tr.querySelectorAll("input");
      let totalMin=0, zileLucrate=0;
      inputs.forEach(i=>{
        const v = (i.value||"").trim().toUpperCase();
        if (v==="CO" || v==="N" || v==="FP") return;
        const m = v.match(/^(\d{1,2}):(\d{2})$/);
        if(m){
          const h = Number(m[1]); const mm = Number(m[2]);
          if(!isNaN(h) && !isNaN(mm)) { totalMin += h*60+mm; zileLucrate++; }
        }
      });
      const H = Math.floor(totalMin/60), M = totalMin%60;
      const normaZi = 8*60;
      const normaTotala = zileLucrate * normaZi;
      const diff = totalMin - normaTotala;

      const totalCell = tr.querySelector(".total");
      totalCell.textContent = `${H}h ${M}m`;
      totalCell.title = `Zile lucrate: ${zileLucrate}\nNormă: ${Math.floor(normaTotala/60)}h ${normaTotala%60}m\nDiferență: ${diff>=0?'+':''}${Math.floor(Math.abs(diff)/60)}h ${Math.abs(diff)%60}m`;

      let badge = totalCell.querySelector('.delta-badge');
      if(!badge){ badge = document.createElement('span'); badge.className='delta-badge'; totalCell.appendChild(badge); }
      const sign = diff === 0 ? 0 : (diff>0?1:-1);
      badge.className = 'delta-badge ' + (sign>0?'delta-plus':sign<0?'delta-minus':'delta-zero');
      const signTxt = diff>0?'+':(diff<0?'-':'±');
      const dH = Math.floor(Math.abs(diff)/60), dM = Math.abs(diff)%60;
      badge.textContent = diff===0 ? 'la normă' : `${signTxt}${dH}h ${dM}m`;
    }

    async function setPontajFirebase(nume, zi, ora, tura){
      const lunaStr = String(lunaNum).padStart(2,"0");
      const ziStr   = String(zi).padStart(2,"0");
      const idDoc = `${slug(nume)}_${anCurent}_${lunaStr}_${ziStr}_tura${tura}`;
      await setDoc(doc(db,"pontaj_lunar",idDoc),{ nume:nume, zi:zi, luna:lunaNum, an:anCurent, ora:ora, tura:tura });
    }

    const switchTuraBase = (id)=>{ document.getElementById("tura1").style.display="none"; document.getElementById("tura2").style.display="none"; document.getElementById(id).style.display=""; };
    window.switchTura = (id)=>{ switchTuraBase(id); };

    // Store previous state to avoid unnecessary DOM updates
    let prevT1 = [], prevT2 = [], prevZileInLuna = 0;
    async function incarcaAngajatiSiConstruieste(){
      const t1 = [], t2 = [];
      const snap = await getDocs(collection(db,"angajati"));
      snap.forEach(d=>{ const a=d.data(); if(a.activ === false) return; if(Number(a.tura) === 1) t1.push(a.nume); if(Number(a.tura) === 2) t2.push(a.nume); });

      const zileChanged = prevZileInLuna !== zileInLuna;
      const t1Changed = t1.length !== prevT1.length || t1.some((v,i)=>v!==prevT1[i]);
      const t2Changed = t2.length !== prevT2.length || t2.some((v,i)=>v!==prevT2[i]);

      if (zileChanged || t1Changed) {
        document.getElementById("tura1_head").innerHTML = "<th>Nume</th>";
        document.getElementById("tura1_body").innerHTML = "";
        buildHeadLunar(document.getElementById("tura1_head"));
        buildBodyLunar(document.getElementById("tura1_body"), t1, 1);
        prevT1 = [...t1];
      }
      if (zileChanged || t2Changed) {
        document.getElementById("tura2_head").innerHTML = "<th>Nume</th>";
        document.getElementById("tura2_body").innerHTML = "";
        buildHeadLunar(document.getElementById("tura2_head"));
        buildBodyLunar(document.getElementById("tura2_body"), t2, 2);
        prevT2 = [...t2];
      }
      prevZileInLuna = zileInLuna;
    }

    (async ()=>{
      try{
        await incarcaAngajatiSiConstruieste();
        await prefillPontaj(1);
        await prefillPontaj(2);
      }catch(e){ console.warn("Prefill pontaj:", e); }
    })();

    // ================== ADMIN (raport & mgmt) ==================
    const adminHead = document.getElementById("admin_head");
    const adminBody = document.getElementById("admin_body");
    const ddlLuna   = document.getElementById("filtruLuna");
    const ddlTura   = document.getElementById("filtruTura");
    const txtNume   = document.getElementById("filtruNume");
    const statusCount = document.getElementById("statusCount");
    const reloadBtn = document.getElementById("reloadBtn");
    const loadSpin = document.getElementById("loadSpin");
    const resetFiltre = document.getElementById("resetFiltre");

    function buildHeadAdmin(){
      adminHead.innerHTML="";
      const cells=["Nume","Tura", ...Array.from({length:31},(_,i)=>String(i+1)),"Total"];
      for(const c of cells){ const th=document.createElement("th"); th.textContent=c; adminHead.appendChild(th); }
      const lunaSel = Number(ddlLuna.value || lunaNum);
      const m0 = lunaSel-1, y = anCurent;
      adminHead.querySelectorAll("th").forEach((th,i)=>{ if(i>=2 && i<=32){ const zi = i-1; if (isWeekend(y,m0,zi)) th.classList.add("weekend"); } });
    }

    async function incarcaAdmin(){
  buildHeadAdmin();
  setLoading(true);

  try {
    // === Construim query-ul cât mai selectiv posibil ===
    const col = collection(db, "pontaj_lunar");
    const wh = [ where("an","==", anCurent) ];

    const lunaSel = ddlLuna.value ? Number(ddlLuna.value) : null;
    if (lunaSel !== null) wh.push( where("luna","==", lunaSel) );

    const turaSel = ddlTura.value ? Number(ddlTura.value) : null;
    if (turaSel !== null) wh.push( where("tura","==", turaSel) );

    // Notă: căutarea "live" după nume parțial nu e susținută nativ în Firestore fără câmpuri auxiliare + orderBy/startAt.
    // De aceea o facem client-side după fetch.
    const q = query(col, ...wh);

    const snap = await getDocs(q);

    // === Agregăm rezultatele ===
    const map = {}; // key = nume_tura_luna
    const needle = (txtNume.value || "").trim().toLowerCase();

    snap.forEach(dref => {
      const d = dref.data();
      // Ignorăm documentele "init" (zi/lună 0)
      if (Number(d.luna) === 0 || Number(d.zi) === 0) return;

      // Filtru local după nume (conține)
      if (needle && !String(d.nume).toLowerCase().includes(needle)) return;

      const key = `${d.nume}_${d.tura}_${d.luna}`;
      if (!map[key]) {
        map[key] = { nume: d.nume, tura: d.tura, luna: d.luna, totalMin: 0, zile: {}, zileLucrate: 0 };
      }
      map[key].zile[d.zi] = d.ora || "";

      const v = String(d.ora || "").trim().toUpperCase();
      if (v !== "CO" && v !== "N" && v !== "FP") {
        const mm = v.match(/^(\d{1,2}):(\d{2})$/);
        if (mm) {
          const h = Number(mm[1]), m = Number(mm[2]);
          if (!isNaN(h) && !isNaN(m)) { map[key].totalMin += h*60 + m; map[key].zileLucrate++; }
        }
      }
    });

    // === Render tabel ===
    adminBody.innerHTML = "";
    let count = 0;
    Object.values(map).forEach(p => {
      const normaTot = p.zileLucrate * 8 * 60;
      const diff = p.totalMin - normaTot;
      const totalTxt = `${Math.floor(p.totalMin/60)}h ${p.totalMin%60}m`;
      const diffTxt  = diff===0 ? "la normă" :
        `${diff>0?'+':'-'}${Math.floor(Math.abs(diff)/60)}h ${Math.abs(diff)%60}m`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="name">${p.nume}</td>
        <td>${p.tura}</td>
        ${Array.from({length:31},(_,i)=>`<td>${p.zile[i+1]||""}</td>`).join("")}
        <td class="total"
            title="Zile lucrate: ${p.zileLucrate}\nNormă: ${Math.floor(normaTot/60)}h ${normaTot%60}m\nDiferență: ${diffTxt}">
          ${totalTxt}
          <span class="delta-badge ${diff>0?'delta-plus':diff<0?'delta-minus':'delta-zero'}">
            ${diff===0?'la normă':diffTxt}
          </span>
        </td>
      `;
      adminBody.appendChild(tr);
      count++;
    });

    if (!count) {
      adminBody.innerHTML = `<tr><td colspan="34" style="padding:10px">Nu sunt date pentru filtrul selectat.</td></tr>`;
    }
    statusCount.textContent = count ? `${count} rânduri` : "0 rânduri";

  } catch (err) {
    console.error("incarcaAdmin (filtrat):", err);
    adminBody.innerHTML = `<tr><td colspan="34" style="padding:10px">Eroare la încărcare. Vezi consolă.</td></tr>`;
    statusCount.textContent = "—";
  } finally {
    setLoading(false);
  }
}


    ddlLuna.addEventListener("change", incarcaAdmin);
    ddlTura.addEventListener("change", incarcaAdmin);
    txtNume.addEventListener("input", debounce(incarcaAdmin, 250));
    resetFiltre.addEventListener("click", ()=>{ ddlLuna.value=""; ddlTura.value=""; txtNume.value=""; incarcaAdmin(); });
    reloadBtn.addEventListener("click", incarcaAdmin);

    function setLoading(is){ loadSpin.style.display = is ? "inline-block" : "none"; reloadBtn.disabled = !!is; }

    function getAdminTableData(){
      const head = [...document.querySelectorAll("#admin_head th")].map(th=>th.textContent);
      const rows = [...document.querySelectorAll("#admin_body tr")].map(tr => [...tr.querySelectorAll("td")].map(td => td.textContent.trim()));
      return {head, rows};
    }

    // ============ EXPORT XLSX ============
    window.exportXLSXAdmin = async function(){
      const {head, rows} = getAdminTableData();
      if (!rows.length || (rows.length===1 && rows[0].length===1)) { alert("Nu există date."); return; }

      const now = new Date();
      const lunaSel = Number(ddlLuna.value || lunaNum);
      const titlu = `Raport pontaj – ${luniRO[lunaSel-1]} ${anCurent}` + (ddlTura.value?` (Tura ${ddlTura.value})`:"");
      const generatLa = `Generat la: ${now.toLocaleString("ro-RO")}`;

      const fillCO = "FFE8F7E8", textCO = "FF0F3D0F";
      const fillN  = "FFFFEAEA", textN  = "FF651010";
      const fillFP = "FFFFF8E6", textFP = "FF5A4100";
      const fillWeekend = "FFE6EEF7";

      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet("Raport", {properties:{defaultRowHeight:16}});
      ws.columns = head.map((h,i)=>{
        if (i === 0) return { width:20 };
        if (i === 1) return { width:8 };
        if (i === head.lenght - 1) return { width:14 };
        return { width:6 };
      });
      ws.getColumn(1).width = 22; ws.getColumn(2).width = 8;

      const totalCol = head.length;
      ws.getColumn(totalCol).alignment = {vertical:"middle", horizontal:"center", wrapText:true};

      ws.addRow([titlu]); ws.getCell("A1").font = {bold:true, size:14};
      ws.mergeCells(1,1,1,head.length);
      ws.addRow([generatLa]); ws.mergeCells(2,1,2,head.length);
      ws.addRow([]);

      const headerRow = ws.addRow(head);
      ws.views = [{state:"frozen", ySplit:4}];
      ws.autoFilter = {
        from : {row: 4, column: 1}, // A4
        to   : {row: 4, column: head.length} // A4..lastCol 
      };


      headerRow.font = {bold:true};
      headerRow.alignment = {vertical:"middle", horizontal:"center"};
      headerRow.eachCell(c=>{ c.fill = {type:"pattern", pattern:"solid", fgColor:{argb:"FFCCE5FF"}}; c.border = {top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}; });

      const m0 = lunaSel-1, y = anCurent;
      for(let zi=1; zi<=31; zi++){
        const col = 2 + zi; // 1=Nume,2=Tura => zi=1 e col 3
        if(col<=head.length && isWeekend(y,m0,zi)){
          const cell = headerRow.getCell(col);
          cell.fill = {type:"pattern", pattern:"solid", fgColor:{argb:fillWeekend}};
        }
      }

      const startColZile = 3; // col 3..33
      rows.forEach(r=>{
        const row = ws.addRow(r);
        row.eachCell((c, colIndex)=>{
          c.border = {top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}};
          c.alignment = {vertical:"middle", horizontal:"center"};
          if (colIndex >= startColZile && colIndex <= head.length-1) {
            const val = String(c.value ?? "").toUpperCase();
            if (val === "CO") { c.fill = {type:"pattern", pattern:"solid", fgColor:{argb:fillCO}}; c.font={color:{argb:textCO}, bold:true}; }
            if (val === "N")  { c.fill = {type:"pattern", pattern:"solid", fgColor:{argb:fillN}};  c.font={color:{argb:textN},  bold:true}; }
            if (val === "FP") { c.fill = {type:"pattern", pattern:"solid", fgColor:{argb:fillFP}}; c.font={color:{argb:textFP},bold:true}; }
          }
        });
      });

      const lastRow = ws.lastRow.number + 1;
      ws.addRow([]);
      ws.addRow(["Legendă: CO = Concediu, N = Nemotivat, FP = Fără plată"]);
      ws.mergeCells(lastRow+1,1,lastRow+1,Math.min(6, head.length));
      ws.getCell(lastRow+1,1).font = {italic:true, size:10, color:{argb:"FF6B7D93"}};

      try{
        const b64 = await fetchToBase64("sigla.png");
        const base64 = b64.startsWith("data:") ? b64.split(",")[1] : b64;
        const imgId = wb.addImage({base64: base64, extension:"png"});
        ws.addImage(imgId, { tl:{col:0, row:0}, ext:{width:140, height:40} });
      }catch(e){ console.warn("Sigla XLSX:", e); }

      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}), `raport_pontaj_${anCurent}_${String(lunaSel).padStart(2,"0")}.xlsx`);
    };

    // ============ EXPORT PDF (patched: coloana "Total" garantat vizibilă) ============
window.exportPDFAdmin = async function(){
  const {head, rows} = getAdminTableData();
  if (!rows.length || (rows.length===1 && rows[0].length===1)) { alert("Nu există date."); return; }

  const now = new Date();
  const lunaSel = Number(ddlLuna.value || lunaNum);
  const title = `Raport pontaj – ${luniRO[lunaSel-1]} ${anCurent}` + (ddlTura.value?` (Tura ${ddlTura.value})`:"");
  const gen   = `Generat la: ${now.toLocaleString("ro-RO")}`;

  // Paletă pentru marcaje speciale
  const rgbCO = [232,247,232], txtCO = [15,61,15];
  const rgbN  = [255,234,234], txtN  = [101,16,16];
  const rgbFP = [255,248,230], txtFP = [90,65,0];
  const rgbWeekendHead = [230,238,247];

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
  const pageWidth  = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  // Header (siglă + titlu)
  try {
    const b64 = await fetchToBase64("sigla.png");
    doc.addImage(b64, "PNG", 24, 20, 120, 34);
  } catch (e) { /* logo opțional */ }
  doc.setFont("helvetica","bold"); doc.setFontSize(14);
  doc.text(title, 160, 36, {maxWidth: pageWidth - 180});
  doc.setFont("helvetica","normal"); doc.setFontSize(10);
  doc.text(gen, 160, 54);

  // --- LĂȚIMI FIXE SIGURE PENTRU A4 LANDSCAPE (include "Total") ---
  const colStyles = {};
  colStyles[0] = { halign:'left', cellWidth: 120 }; // Nume
  colStyles[1] = { cellWidth: 30 };                 // Tura
  for (let i = 2; i <= head.length - 2; i++) {      // Zile (1..31)
    colStyles[i] = { cellWidth: 18 };
  }
  colStyles[head.length - 1] = { cellWidth: 60 };   // Total

  // NOTĂ: nu folosi "tableWidth:'wrap'" sau scale hacks; la nevoie, micșorează puțin lățimile de mai sus.

  doc.autoTable({
    startY: 74,
    head: [head],
    body: rows,
    tableWidth: 'auto',
    styles:     { fontSize:8, cellPadding:3, halign:'center', valign:'middle', overflow:'linebreak' },
    headStyles: { fillColor:[204,229,255], textColor:0, halign:'center' },
    columnStyles: colStyles,
    theme: 'grid',
    margin: { left:24, right:24, top:74, bottom:24 },

    // Colorează weekend-urile în header și CO/N/FP în corp
    didParseCell: (data) => {
      if (data.section === 'head') {
        const i = data.column.index;
        if (i >= 2 && i <= head.length - 2) {
          const zi = i - 1;
          if (isWeekend(anCurent, lunaSel - 1, zi)) {
            data.cell.styles.fillColor = rgbWeekendHead;
          }
        }
      }
      if (data.section === 'body') {
        const colIdx = data.column.index;
        const isZi = (colIdx >= 2 && colIdx <= head.length - 2);
        if (!isZi) return;
        const val = String(data.cell.raw ?? "").toUpperCase();
        if (val === "CO") { data.cell.styles.fillColor = rgbCO; data.cell.styles.textColor = txtCO; data.cell.styles.fontStyle = 'bold'; }
        if (val === "N")  { data.cell.styles.fillColor = rgbN;  data.cell.styles.textColor = txtN;  data.cell.styles.fontStyle = 'bold'; }
        if (val === "FP") { data.cell.styles.fillColor = rgbFP; data.cell.styles.textColor = txtFP; data.cell.styles.fontStyle = 'bold'; }
      }
    },

    // Zebra striping discret pentru lizibilitate (nu afectează "Total")
    willDrawCell: (data) => {
      if (data.section === 'body' && data.row.index % 2 === 1) {
        data.cell.styles.fillColor = data.cell.styles.fillColor || [31,45,70];
      }
    }
  });

  // Footer: număr de pagină
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(9); doc.setTextColor(120);
    doc.text(`Pagina ${i} / ${pageCount}`, pageWidth - 80, pageHeight - 12);
  }

  doc.save(`raport_pontaj_${anCurent}_${String(lunaSel).padStart(2,"0")}.pdf`);
};


    // util: încarcă imagine și întoarce DataURL
    async function fetchToBase64(url){
      const res = await fetch(url);
      const blob = await res.blob();
      return await new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
    document.addEventListener("DOMContentLoaded", ()=> {
      const adminTab = document.querySelector('.tab[data-tab="admin"]');
      if (adminTab && adminTab.classList.contains("active")) incarcaAdmin();
    });

    // ==================== CRUD angajați ====================
    window.adaugaAngajat = async function(){
      const nume = prompt("Introduceți numele complet:");
      const tura = prompt("Introduceți tura (1 sau 2):");
      if(!nume || !tura) return alert("Date incomplete.");

      const badge = genBadge(); // cod intern, dacă vrei să-l folosești ulterior
      await setDoc(doc(db, "angajati", slug(nume)), { nume: nume, tura: Number(tura), activ: true, badge });

      const initId = `${slug(nume)}_${new Date().getFullYear()}_init_tura${tura}`;
      await setDoc(doc(db, "pontaj_lunar", initId), { nume, zi:0, luna:0, an:new Date().getFullYear(), ora:"00:00", tura:Number(tura) });

      alert(`Angajat adăugat.`);

      await incarcaAdmin();
      await incarcaAngajatiSiConstruieste();
      await prefillPontaj(1); await prefillPontaj(2);
    };

    window.stergeAngajat = async function(){
      const nume = prompt("Numele complet de șters:");
      if(!nume) return;

      await setDoc(doc(db, "angajati", slug(nume)), { activ: false }, { merge: true });

      const snap = await getDocs(collection(db,"pontaj_lunar"));
      const toDel = snap.docs.filter(d=>d.data().nume===nume);
      for(const d of toDel) await deleteDoc(d.ref);

      alert(`Angajatul '${nume}' a fost dezactivat și pontajul șters.`);
      await incarcaAdmin();
      await incarcaAngajatiSiConstruieste();
    };

    window.editeazaAngajat = async function(){
      const numeVechi = prompt("Numele actual:");
      if(!numeVechi) return;
      const numeNou  = prompt("Noul nume (Enter pt. același):", numeVechi);
      const turaNoua = prompt("Noua tură (1/2 sau Enter):");

      const refVechi = doc(db, "angajati", slug(numeVechi));
      const nou = { ...(numeNou ? { nume: numeNou } : {}), ...(turaNoua ? { tura: Number(turaNoua) } : {}), activ: true };
      if (numeNou && slug(numeNou) !== slug(numeVechi)) {
        const refNou = doc(db, "angajati", slug(numeNou));
        await setDoc(refNou, nou, { merge: true });
        await setDoc(refVechi, { activ:false }, { merge: true });
      } else {
        await setDoc(refVechi, nou, { merge: true });
      }

      const snap = await getDocs(collection(db,"pontaj_lunar"));
      const docs = snap.docs.filter(d=>d.data().nume===numeVechi);
      for (const d of docs) {
        const data = d.data();
        const newNume = numeNou || data.nume;
        const newTura = turaNoua ? Number(turaNoua) : data.tura;
        const newId   = `${slug(newNume)}_${data.an}_${String(data.luna).padStart(2,'0')}_${String(data.zi).padStart(2,'0')}_tura${newTura}`;
        await setDoc(doc(db,"pontaj_lunar",newId), { ...data, nume:newNume, tura:newTura });
        await deleteDoc(d.ref);
      }

      alert("Actualizat.");
      await incarcaAdmin();
      await incarcaAngajatiSiConstruieste();
      await prefillPontaj(1); await prefillPontaj(2);
    };

    // ==================== RESET PONTAJ ====================
    window.resetPontaj = async function(scope='all'){
      let confirmMsg = "Sigur doriți să resetați pontajul?";
      if(!confirm(confirmMsg)) return;

      let q;
      const col = collection(db, "pontaj_lunar");
      if (scope === 'vizibil') {
        const turaViz = (document.getElementById("tura1").style.display !== "none") ? 1 : 2;
        q = query(col, where("an","==", anCurent), where("luna","==", lunaNum), where("tura","==", turaViz));
      } else {
        q = query(col, where("an","==", anCurent), where("luna","==", lunaNum));
      }

      const snap = await getDocs(q);
      // limit batch 500 → folosim 450 pt. siguranță
      let batch = writeBatch(db), count = 0;
      for (const d of snap.docs) {
        const data = d.data();
        if (Number(data.zi) > 0) { batch.delete(d.ref); count++; if (count % 450 === 0) { await batch.commit(); batch = writeBatch(db); } }
      }
      if (count > 0) await batch.commit();

      alert(`Șters ${count} înregistrări din luna curentă.`);
      await incarcaAdmin();
      await incarcaAngajatiSiConstruieste();
      await prefillPontaj(1); await prefillPontaj(2);
    };

    window.resetPontajAngajat = async function(){
      const nume = prompt("Introdu numele COMPLET al angajatului pentru reset:");
      if(!nume) return;
      const turaStr = prompt("Tura (1 sau 2). Lasă gol dacă vrei ambele ture pentru acest nume:");
      const turaNum = (turaStr !== null && turaStr.trim() !== "") ? Number(turaStr) : null;
      if(!confirm(`Șterg orele din luna curentă pentru "${nume}"${turaNum !== null ? ` (tura ${turaNum})` : ''}. Continui?`)) return;

      const col = collection(db, "pontaj_lunar");
      let q = query(col, where("an","==", anCurent), where("luna","==", lunaNum), where("nume","==", nume));
      if (turaNum !== null) q = query(col, where("an","==", anCurent), where("luna","==", lunaNum), where("nume","==", nume), where("tura","==", turaNum));

      const snap = await getDocs(q);
      let batch = writeBatch(db), count = 0;
      for (const d of snap.docs) {
        const data = d.data();
        if (Number(data.zi) > 0) {
          batch.delete(d.ref); count++;
          if (count % 450 === 0) { await batch.commit(); batch = writeBatch(db); }
        }
      }
      if (count > 0) await batch.commit();
      alert(`Șters ${count} înregistrări pentru ${nume} în luna curentă${turaNum!==null?` (tura ${turaNum})`:''}.`);
      await incarcaAdmin();
      await incarcaAngajatiSiConstruieste();
      await prefillPontaj(1); await prefillPontaj(2);
    };
  </script>

  <!-- ExcelJS + FileSaver pentru XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- jsPDF + AutoTable (UMD) pentru PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Datalist pentru coduri speciale (CO / N / FP) -->
  <datalist id="coduriPontaj">
    <option value="CO" label="Concediu"></option>
    <option value="N"  label="Nemotivat"></option>
    <option value="FP" label="Fără plată"></option>
  </datalist>
</body>
</html>
