<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Pontaj – Lunar & Admin (unificat, cu colecția angajati)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0d1b2a; --card:#1b263b; --muted:#415a77; --accent:#00bcd4; --accent2:#ff0055;
      --text:#eef2f6; --thead:#0f3554; --thead2:#007acc; --border:#2e3b55;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
    header{
      display:flex;align-items:center;gap:12px;justify-content:center;
      padding:14px 18px;background:linear-gradient(90deg,#003566 0%, #0b3d5c 100%);
      border-bottom:1px solid #09314d
    }
    header img{height:36px}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}

    .print-header{display:none} /* vizibil doar la print */

    .toolbar,.tabs{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:10px}
    .toolbar{
      background:rgba(255,255,255,.03);border-top:1px solid #0f2536;border-bottom:1px solid #0f2536
    }
    select,input,button{
      padding:8px 10px;font-size:13px;border-radius:8px;border:1px solid var(--border);background:#102338;color:var(--text)
    }
    button{background:var(--accent);border:none;color:#04202e;font-weight:600;cursor:pointer}
    button.secondary{background:#14324a;color:var(--text);border:1px solid var(--border)}
    button.danger{background:#d9534f;color:#fff;border:none}
    button.tab{background:#14324a}
    .tab.active{background:var(--accent2);color:#fff}

    .wrap{padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}

    .tab-content{display:none}
    .tab-content.active{display:block}

    .scroll-x{overflow-x:auto}

    table{width:100%;border-collapse:collapse;background:#0f2133;border-radius:12px;overflow:hidden}
    th,td{border:1px solid #12314a;text-align:center}
    th{position:sticky;top:0;background:var(--thead2);color:#fff;font-weight:600}
    td{background:#0d2032}
    td:first-child, th:first-child{position:sticky;left:0;background:#0f3554;z-index:1}
    td.name{background:#123; font-weight:600}

    /* Celule compacte pentru luna întreagă pe ecran */
    th,td{padding:6px;font-size:11px}
    input[type="text"]{
      width:46px;min-width:46px;text-align:center;font-size:11px;
      background:#e0f7ff;color:#05121b;border:1px solid #9fd3e6;border-radius:6px;padding:3px 4px
    }
    .total{font-weight:700;background:#112b40}

    .section-title{font-size:14px;margin:0 0 10px 4px;color:#b7cdf0}

    /* ===== Coduri speciale (CO / N / FP) stilizare pe ecran ===== */
    .cod-CO input{ background:#e8f7e8 !important; border-color:#9ed39e !important; color:#0f3d0f !important; }
    .cod-N  input{ background:#ffeaea !important; border-color:#f5a5a5 !important; color:#651010 !important; }
    .cod-FP input{ background:#fff8e6 !important; border-color:#f1d28a !important; color:#5a4100 !important; }

    /* ===== Print: doar tabelul + antet cu siglă ===== */
    @media print {
      @page { size: A4 landscape; margin: 10mm; }
      body { background:#fff; color:#000; }

      /* ascunde UI */
      header, .tabs, .toolbar, .section-title,
      button, select, input { display: none !important; }

      /* arată doar tabul de pontaj lunar (raportul) */
      #admin { display: none !important; }
      #lunar { display: block !important; }

      /* antetul PDF cu siglă */
      .print-header {
        display: flex !important;
        align-items: center;
        gap: 12px;
        margin: 0 16px 10px 16px;
        padding-bottom: 6px;
        border-bottom: 2px solid #000;
      }
      .print-header img { height: 28px; }
      .print-header h2 { margin:0; font-size:16px; color:#000; }
      .print-header small { font-weight: normal; font-size: 12px; }

      /* tabel stilizat pentru tipar */
      .wrap { padding: 0 !important; }
      .card { border: none !important; padding: 0 !important; }
      .scroll-x { overflow: visible !important; }

      table { width: 100% !important; border-collapse: collapse !important; }
      th, td {
        border: 1px solid #000 !important;
        background: #fff !important;
        color: #000 !important;
        position: static !important;
        padding: 5px 6px !important;
        font-size: 11px !important;
      }
      th {
        background: #f0f0f0 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      td.name { font-weight: 700 !important; }
      td.total, th:last-child { font-weight: 700 !important; }

      /* contur subtil pt. codurile speciale la print */
      .cod-CO td { border:1px solid #0a0 !important; }
      .cod-N  td { border:1px solid #a00 !important; }
      .cod-FP td { border:1px solid #aa8800 !important; }

      /* evită tăieri urâte */
      tr { break-inside: avoid; page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <header>
    <img src="sigla.png" alt="Sigla" />
    <h1>Pontaj – Lunar & Admin</h1>
  </header>

  <!-- Antet DOAR pentru PDF -->
  <div class="print-header">
    <img src="sigla.png" alt="Sigla" />
    <div>
      <h2>Raport pontaj – <span id="printMonth"></span> <small>(<span id="printTura"></span>)</small></h2>
      <p style="margin:4px 0 0; opacity:.8">Generat la: <span id="printNow"></span></p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="lunar">Pontaj Lunar</button>
    <button class="tab" data-tab="admin">Raport & Management</button>
  </div>

  <div class="wrap">

    <!-- ========= PONTAJ LUNAR ========= -->
    <section id="lunar" class="tab-content active">
      <div class="card">
        <h3 class="section-title">Ture</h3>
        <div class="toolbar" style="justify-content:flex-start">
          <button class="secondary" onclick="switchTura('tura1')">Tura 1</button>
          <button class="secondary" onclick="switchTura('tura2')">Tura 2</button>
          <span style="margin-left:8px;opacity:.8">Luna curentă</span>
        </div>

        <div class="scroll-x">
          <table id="tura1">
            <thead><tr id="tura1_head"><th>Nume</th></tr></thead>
            <tbody id="tura1_body"></tbody>
          </table>

          <table id="tura2" style="display:none;margin-top:14px">
            <thead><tr id="tura2_head"><th>Nume</th></tr></thead>
            <tbody id="tura2_body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========= ADMIN ========= -->
    <section id="admin" class="tab-content">
      <div class="card">
        <h3 class="section-title">Filtre & Export</h3>
        <div class="toolbar">
          <label>Luna
            <select id="filtruLuna">
              <option value="">Toate</option>
              <option value="1">Ianuarie</option><option value="2">Februarie</option>
              <option value="3">Martie</option><option value="4">Aprilie</option>
              <option value="5">Mai</option><option value="6">Iunie</option>
              <option value="7">Iulie</option><option value="8">August</option>
              <option value="9">Septembrie</option><option value="10">Octombrie</option>
              <option value="11">Noiembrie</option><option value="12">Decembrie</option>
            </select>
          </label>
          <label>Tura
            <select id="filtruTura">
              <option value="">Toate</option>
              <option value="1">Tura 1</option>
              <option value="2">Tura 2</option>
            </select>
          </label>
          <input id="filtruNume" type="text" placeholder="Filtru nume" />
          <button id="filtruBtn">Aplică filtre</button>
          <button onclick="exportCSV()">Export CSV</button>
          <button onclick="window.print()">Export PDF</button>
        </div>

        <h3 class="section-title">Management angajați</h3>
        <div class="toolbar">
          <button onclick="adaugaAngajat()">Adaugă</button>
          <button onclick="editeazaAngajat()">Editează</button>
          <button class="danger" onclick="stergeAngajat()">Șterge</button>
        </div>

        <div class="scroll-x">
          <table>
            <thead>
              <tr id="admin_head"></tr>
            </thead>
            <tbody id="admin_body"><tr><td>Se încarcă…</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- ========== SCRIPT APLICAȚIE (Firebase unic + ambele module) ========== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // ---------- CONFIG FIREBASE ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAQ35cuycNSMlaQ4RL0JHmN5oDOKXCY-ls",
      authDomain: "pontaj2025.firebaseapp.com",
      projectId: "pontaj2025",
      storageBucket: "pontaj2025.firebasestorage.app",
      messagingSenderId: "732863008010",
      appId: "1:732863008010:web:e2b7ed0220f9fb4bcc3ef3"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const slug = s => s.toLowerCase().trim().replace(/\s+/g,'_').replace(/[^\w_-]/g,'');

    // ---------- TAB SWITCH ----------
    document.querySelectorAll(".tab").forEach(b=>{
      b.addEventListener("click",()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        document.getElementById(b.dataset.tab).classList.add("active");
        if(b.dataset.tab === "admin") incarcaAdmin();
      });
    });

    // =========================================================
    // ===============    PONTAJ LUNAR (Ture)    ===============
    // =========================================================
    const today = new Date();
    const lunaIdx = today.getMonth();         // 0..11
    const lunaNum = lunaIdx + 1;              // 1..12
    const anCurent = today.getFullYear();
    const zileInLuna = new Date(anCurent, lunaIdx + 1, 0).getDate();

    // Luni în RO pentru antet PDF / CSV
    const luniRO = ["Ianuarie","Februarie","Martie","Aprilie","Mai","Iunie","Iulie","August","Septembrie","Octombrie","Noiembrie","Decembrie"];

    // Elemente antet print
    const printMonthEl = document.getElementById("printMonth");
    const printTuraEl  = document.getElementById("printTura");
    const printNowEl   = document.getElementById("printNow");
    if (printMonthEl) {
      printMonthEl.textContent = `${luniRO[lunaIdx]} ${anCurent}`;
      printTuraEl.textContent  = "Tura 1"; // implicit
      printNowEl.textContent   = new Date().toLocaleString("ro-RO");
    }

    function buildHeadLunar(elHead){
      for(let zi=1; zi<=zileInLuna; zi++){
        const th=document.createElement("th");
        th.textContent = zi;
        elHead.appendChild(th);
      }
      const thT=document.createElement("th");
      thT.textContent="Total ore";
      elHead.appendChild(thT);
    }

    function buildBodyLunar(tbody, listaNume, tura){
      tbody.innerHTML = "";
      listaNume.forEach(nume=>{
        const tr=document.createElement("tr");
        const tdN=document.createElement("td");
        tdN.className="name";
        tdN.textContent=nume;
        tr.appendChild(tdN);

        for(let zi=1; zi<=zileInLuna; zi++){
          const td=document.createElement("td");
          const inp=document.createElement("input");
          inp.type="text"; inp.placeholder="hh:mm";
          inp.setAttribute("list","coduriPontaj"); // autocomplete pentru CO/N/FP
          inp.dataset.nume=nume; inp.dataset.zi=zi; inp.dataset.tura=tura;

          // functie de marcare vizuala in functie de valoare
          const markCode = (val)=>{
            td.classList.remove("cod-CO","cod-N","cod-FP");
            if (val === "CO") td.classList.add("cod-CO");
            if (val === "N")  td.classList.add("cod-N");
            if (val === "FP") td.classList.add("cod-FP");
          };

          inp.addEventListener("input", ()=> markCode(inp.value.trim().toUpperCase()));
          inp.addEventListener("change", async ()=>{
            // normalizam: acceptam si "co"/"Co" etc.
            inp.value = inp.value.trim().toUpperCase();
            markCode(inp.value);
            calcTotalRow(tr);
            await setPontajFirebase(nume, zi, inp.value, tura);
          });

          td.appendChild(inp);
          tr.appendChild(td);
        }

        const tdTot=document.createElement("td");
        tdTot.className="total"; tdTot.textContent="0h 0m";
        tr.appendChild(tdTot);

        tbody.appendChild(tr);
      });
    }

    function calcTotalRow(tr){
      const inputs = tr.querySelectorAll("input");
      let totalMin=0;
      inputs.forEach(i=>{
        const v = (i.value||"").trim().toUpperCase();
        // coduri speciale nu se aduna
        if (v==="CO" || v==="N" || v==="FP") return;
        if(/^\d{1,2}:\d{2}$/.test(v)){
          const [h,m] = v.split(":").map(Number);
          if(!isNaN(h) && !isNaN(m)) totalMin += h*60+m;
        }
      });
      const H = Math.floor(totalMin/60), M = totalMin%60;
      tr.querySelector(".total").textContent = `${H}h ${M}m`;
    }

    async function setPontajFirebase(nume, zi, ora, tura){
      const lunaStr = String(lunaNum).padStart(2,"0");
      const ziStr   = String(zi).padStart(2,"0");
      const idDoc = `${slug(nume)}_${anCurent}_${lunaStr}_${ziStr}_tura${tura}`;
      await setDoc(doc(db,"pontaj_lunar",idDoc),{
        nume:nume, zi:zi, luna:lunaNum, an:anCurent, ora:ora, tura:tura
      });
    }

    // comutare tura + actualizare antet print
    const _switchTuraBase = (id)=>{
      document.getElementById("tura1").style.display="none";
      document.getElementById("tura2").style.display="none";
      document.getElementById(id).style.display="";
    };
    window.switchTura = (id)=>{
      _switchTuraBase(id);
      if (printTuraEl) printTuraEl.textContent = (id === "tura1") ? "Tura 1" : "Tura 2";
    };

    // încarcă angajații din colecția `angajati` și construiește tabelele Lunar
    async function incarcaAngajatiSiConstruieste(){
      const t1 = [], t2 = [];
      const snap = await getDocs(collection(db,"angajati"));
      snap.forEach(d=>{
        const a = d.data();
        if(a.activ === false) return;
        if(Number(a.tura) === 1) t1.push(a.nume);
        if(Number(a.tura) === 2) t2.push(a.nume);
      });

      // reset heads & bodies
      document.getElementById("tura1_head").innerHTML = "<th>Nume</th>";
      document.getElementById("tura2_head").innerHTML = "<th>Nume</th>";
      document.getElementById("tura1_body").innerHTML = "";
      document.getElementById("tura2_body").innerHTML = "";

      buildHeadLunar(document.getElementById("tura1_head"));
      buildBodyLunar(document.getElementById("tura1_body"), t1, 1);

      buildHeadLunar(document.getElementById("tura2_head"));
      buildBodyLunar(document.getElementById("tura2_body"), t2, 2);
    }

    // Construiește secțiunea Lunar la start
    incarcaAngajatiSiConstruieste();


    // =========================================================
    // ===============   ADMIN (raport & mgmt)   ===============
    // =========================================================
    const adminHead = document.getElementById("admin_head");
    const adminBody = document.getElementById("admin_body");
    const filtruBtn = document.getElementById("filtruBtn");
    const ddlLuna   = document.getElementById("filtruLuna");
    const ddlTura   = document.getElementById("filtruTura");
    const txtNume   = document.getElementById("filtruNume");

    function buildHeadAdmin(){
      adminHead.innerHTML="";
      const cells=["Nume","Tura", ...Array.from({length:31},(_,i)=>String(i+1)),"Total"];
      for(const c of cells){
        const th=document.createElement("th"); th.textContent=c; adminHead.appendChild(th);
      }
    }

    async function incarcaAdmin(){
      buildHeadAdmin();
      const snap = await getDocs(collection(db,"pontaj_lunar"));
      const map = {}; // key = nume_tura_luna

      snap.forEach(dref=>{
        const d = dref.data();
        // filtre
        if(ddlLuna.value && Number(ddlLuna.value)!==Number(d.luna)) return;
        if(ddlTura.value && Number(ddlTura.value)!==Number(d.tura)) return;
        if(txtNume.value && !String(d.nume).toLowerCase().includes(txtNume.value.toLowerCase())) return;

        const key = `${d.nume}_${d.tura}_${d.luna}`;
        if(!map[key]) map[key] = {nume:d.nume, tura:d.tura, luna:d.luna, totalMin:0, zile:{}};
        map[key].zile[d.zi] = d.ora || "";

        // totalul: ignoră CO / N / FP
        const v = String(d.ora||"").trim().toUpperCase();
        if(v!=="CO" && v!=="N" && v!=="FP"){
          const mm = v.match(/^(\d{1,2}):(\d{2})$/);
          if (mm){
            const h = Number(mm[1]), m = Number(mm[2]);
            if(!isNaN(h)&&!isNaN(m)) map[key].totalMin += h*60+m;
          }
        }
      });

      adminBody.innerHTML="";
      Object.values(map).forEach(p=>{
        const tr=document.createElement("tr");
        const total = `${Math.floor(p.totalMin/60)}h ${p.totalMin%60}m`;
        tr.innerHTML = `
          <td class="name">${p.nume}</td>
          <td>${p.tura}</td>
          ${Array.from({length:31},(_,i)=>`<td>${p.zile[i+1]||""}</td>`).join("")}
          <td class="total">${total}</td>
        `;
        adminBody.appendChild(tr);
      });
      if(!adminBody.children.length){
        adminBody.innerHTML = `<tr><td colspan="34" style="padding:10px">Nu sunt date pentru filtrul selectat.</td></tr>`;
      }
    }

    filtruBtn.addEventListener("click", incarcaAdmin);

    // ===== Export CSV îmbunătățit: meta-informații (nu poate include logo/stiluri) =====
    window.exportCSV = function(){
      const now = new Date();
      const turaVizibila = document.getElementById("tura2").style.display === "none" ? "Tura 1" : "Tura 2";
      const titlu = `Raport pontaj – ${luniRO[lunaIdx]} ${anCurent} (${turaVizibila})`;
      const generatLa = `Generat la, ${now.toLocaleString("ro-RO")}`;

      const head = [...document.querySelectorAll("#admin_head th")].map(th=>th.textContent);
      const rows = [...document.querySelectorAll("#admin_body tr")].map(tr =>
        [...tr.querySelectorAll("td")].map(td => td.textContent.replaceAll(","," ").trim())
      );

      const lines = [];
      lines.push(titlu);
      lines.push(generatLa);
      lines.push(""); // rând gol
      lines.push(head.join(","));
      rows.forEach(r=>lines.push(r.join(",")));

      const csv = lines.join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=`pontaj_admin_${anCurent}_${String(lunaNum).padStart(2,"0")}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };

    // ==================== CRUD angajați (colecția `angajati`) ====================
    window.adaugaAngajat = async function(){
      const nume = prompt("Introduceți numele complet:");
      const tura = prompt("Introduceți tura (1 sau 2):");
      if(!nume || !tura) return alert("Date incomplete.");

      // 1) creează/actualizează angajatul în `angajati`
      await setDoc(doc(db, "angajati", slug(nume)), {
        nume: nume, tura: Number(tura), activ: true
      });

      // 2) (opțional) creează un doc inițial în pontaj_lunar ca să apară în rapoarte
      const initId = `${slug(nume)}_${new Date().getFullYear()}_init_tura${tura}`;
      await setDoc(doc(db, "pontaj_lunar", initId), {
        nume, zi:0, luna:0, an:new Date().getFullYear(), ora:"00:00", tura:Number(tura)
      });

      alert("Angajat adăugat.");
      await incarcaAdmin();                 // actualizează raportul
      await incarcaAngajatiSiConstruieste();// actualizează imediat și „Pontaj Lunar”
    };

    window.stergeAngajat = async function(){
      const nume = prompt("Numele complet de șters:");
      if(!nume) return;

      // 1) marchează inactiv în `angajati` (păstrăm istoric)
      await setDoc(doc(db, "angajati", slug(nume)), { activ: false }, { merge: true });

      // 2) (opțional) șterge toate înregistrările din pontaj_lunar pentru acest nume
      const snap = await getDocs(collection(db,"pontaj_lunar"));
      const toDel = snap.docs.filter(d=>d.data().nume===nume);
      for(const d of toDel) await deleteDoc(d.ref);

      alert(`Angajatul '${nume}' a fost dezactivat și pontajul șters.`);
      await incarcaAdmin();
      await incarcaAngajatiSiConstruieste();
    };

    window.editeazaAngajat = async function(){
      const numeVechi = prompt("Numele actual:");
      if(!numeVechi) return;
      const numeNou  = prompt("Noul nume (Enter pt. același):", numeVechi);
      const turaNoua = prompt("Noua tură (1/2 sau Enter):");

      // 1) actualizează documentul din `angajati`
      const refVechi = doc(db, "angajati", slug(numeVechi));
      const nou = {
        ...(numeNou ? { nume: numeNou } : {}),
        ...(turaNoua ? { tura: Number(turaNoua) } : {}),
        activ: true
      };
      if (numeNou && slug(numeNou) !== slug(numeVechi)) {
        const refNou = doc(db, "angajati", slug(numeNou));
        await setDoc(refNou, nou, { merge: true });
        await setDoc(refVechi, { activ:false }, { merge: true });
      } else {
        await setDoc(refVechi, nou, { merge: true });
      }

      // 2) actualizează și toate documentele existente din 'pontaj_lunar'
      const snap = await getDocs(collection(db,"pontaj_lunar"));
      const docs = snap.docs.filter(d=>d.data().nume===numeVechi);
      for (const d of docs) {
        const data = d.data();
        const newNume = numeNou || data.nume;
        const newTura = turaNoua ? Number(turaNoua) : data.tura;
        const newId   = `${slug(newNume)}_${data.an}_${String(data.luna).padStart(2,'0')}_${String(data.zi).padStart(2,'0')}_tura${newTura}`;
        await setDoc(doc(db,"pontaj_lunar",newId), { ...data, nume:newNume, tura:newTura });
        await deleteDoc(d.ref);
      }

      alert("Actualizat.");
      await incarcaAdmin();
      await incarcaAngajatiSiConstruieste();
    };

  </script>

  <!-- Sugestii pentru coduri speciale CO / N / FP -->
  <datalist id="coduriPontaj">
    <option value="CO" label="Concediu"></option>
    <option value="N"  label="Nemotivat"></option>
    <option value="FP" label="Fără plată"></option>
  </datalist>
</body>
</html>
