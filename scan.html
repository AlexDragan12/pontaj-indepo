<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Scanare Pontaj</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0e1b2b; --card:#16243a; --text:#f5f8ff; --muted:#9bb1d6;
      --accent:#00c6ff; --ok:#19c37d; --err:#e74c3c; --border:#2a3a55;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;align-items:center;justify-content:center}
    .wrap{width:100%;max-width:680px;padding:24px}
    header{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:18px;text-align:center}
    header img{height:80px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);box-shadow:0 6px 24px rgba(0,0,0,.25)}
    header h1{margin:0;font-size:24px;letter-spacing:.3px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.22)}
    .scanbox{display:flex;gap:10px}
    .scanbox input{
      flex:1;padding:18px 16px;border-radius:14px;border:1px solid var(--border);
      background:#0f2136;color:#fff;font-size:22px;line-height:28px;outline:none
    }
    .btn{cursor:pointer;border:0;background:var(--accent);color:#00111a;border-radius:12px;padding:14px 18px;font-weight:700;letter-spacing:.2px}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
    .status{margin-top:16px;border:1px solid var(--border);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .badge{display:inline-block;border-radius:999px;padding:6px 10px;font-weight:700}
    .ok {background:rgba(25,195,125,.18); color:#b8ffd9}
    .err{background:rgba(231,76,60,.18); color:#ffd0d0}
    .neutral{background:#0f2136; color:#cfe3ff}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kv{background:#0f2136;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .kv label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
    .kv div{font-weight:700}
    .footer{display:flex;justify-content:center;margin-top:14px}
    .link{color:#a6c8ff;text-decoration:none}
    @media (max-width:560px){ .grid{grid-template-columns:1fr} .scanbox{flex-direction:column} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="sigla.png" alt="Siglă" />
      <h1>Scanează pentru Intrare / Ieșire</h1>
    </header>

    <div class="card">
      <div class="scanbox">
        <input id="scanInput" type="text" placeholder="Scanează badge sau scrie numele exact" autocomplete="off" autofocus />
        <button class="btn" id="scanBtn">Scanează</button>
      </div>
      <div class="hint">Scannerul trimite automat Enter. Manual: tastează numele/badge și apasă Enter sau „Scanează”.</div>

      <div class="status" id="statusBox">
        <span class="badge neutral" id="statusBadge">Aștept</span>
        <div>
          <div id="statusTitle" style="font-weight:700">Aștept scanare…</div>
          <div id="statusSub" style="color:var(--muted);font-size:12px">Introduceți codul și apăsați Enter.</div>
        </div>
      </div>

      <div class="grid">
        <div class="kv"><label>Angajat</label><div id="empName">—</div></div>
        <div class="kv"><label>Stare sesiune</label><div id="sessState">—</div></div>
        <div class="kv"><label>Start</label><div id="tStart">—</div></div>
        <div class="kv"><label>Stop</label><div id="tStop">—</div></div>
      </div>

      <div class="footer"><a class="link" href="index.html">⟵ Înapoi la Pontaj</a></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, runTransaction
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // === Firebase (identic cu index.html) ===
    const firebaseConfig = {
      apiKey: "AIzaSyAQ35cuycNSMlaQ4RL0JHmN5oDOKXCY-ls",
      authDomain: "pontaj2025.firebaseapp.com",
      projectId: "pontaj2025",
      storageBucket: "pontaj2025.appspot.com",
      messagingSenderId: "732863008010",
      appId: "1:732863008010:web:e2b7ed0220f9fb4bcc3ef3"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // === Mini utilitare (câteva linii, fără complicații) ===
    const $ = id => document.getElementById(id);
    const slug = s => String(s||"").toLowerCase().trim().replace(/\s+/g,'_').replace(/[^\w_-]/g,'');
    const toHHMM = mins => `${String(Math.floor(mins/60)).padStart(2,'0')}:${String(mins%60).padStart(2,'0')}`;
    const fmt = d => d.toLocaleTimeString("ro-RO",{hour:'2-digit',minute:'2-digit',second:'2-digit'});

    function setStatus(kind, title, sub=""){
      const badge = $("statusBadge"), box = $("statusBox");
      badge.className = "badge " + (kind==="ok"?"ok":kind==="err"?"err":"neutral");
      badge.textContent = kind==="ok" ? "OK" : kind==="err" ? "Eroare" : "Aștept";
      $("statusTitle").textContent = title;
      $("statusSub").textContent = sub;
    }

    // Caută angajatul: mai întâi după badge (dacă ai câmpul), altfel după nume exact
    async function findEmp(val){
      const v = String(val).trim();
      let s = await getDocs(query(collection(db,"angajati"), where("badge","==", v)));
      if (!s.empty) return s.docs[0].data();
      s = await getDocs(query(collection(db,"angajati"), where("nume","==", v)));
      if (!s.empty) return s.docs[0].data();
      return null;
    }

    // Scrie minute pe zi (adună la ce există)
    async function addMinutesForDay(tx, nume, tura, dateObj, addMin){
      if (addMin <= 0) return;
      const an = dateObj.getFullYear(), luna = dateObj.getMonth()+1, zi = dateObj.getDate();
      const id  = `${slug(nume)}_${an}_${String(luna).padStart(2,'0')}_${String(zi).padStart(2,'0')}_tura${tura}`;
      const ref = doc(db, "pontaj_lunar", id);
      const snap = await tx.get(ref);
      let total = addMin;
      if (snap.exists()){
        const v = String(snap.data().ora || "");
        const m = v.match(/^(\d{1,2}):(\d{2})$/);
        if (m) total += Number(m[1])*60 + Number(m[2]);
      }
      tx.set(ref, { nume, zi, luna, an, ora: toHHMM(total), tura }, { merge: true });
    }

    // Împarte sesiunea dacă trece de miezul nopții (cod scurt)
    function segments(start, end){
      const segs = [];
      let cur = new Date(start);
      while(true){
        const midnight = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate()+1);
        const endTs = Math.min(midnight.getTime(), end.getTime());
        const mins = Math.max(0, Math.round((endTs - cur.getTime())/60000));
        segs.push({ d: new Date(cur.getFullYear(), cur.getMonth(), cur.getDate()), m: mins });
        if (endTs === end.getTime()) break;
        cur = new Date(endTs);
      }
      return segs;
    }

    async function handleScan(raw){
      const code = String(raw||"").trim();
      if (!code){ setStatus("neutral","Aștept scanare…","Introduceți codul și apăsați Enter."); return; }

      try{
        setStatus("neutral","Caut angajat…","");
        const emp = await findEmp(code);
        if (!emp){ setStatus("err","Cod necunoscut","Nu am găsit angajatul."); return; }

        const nume = emp.nume;
        const tura = Number(emp.tura || 1);
        const act  = doc(db, "pontaje_active", slug(nume));

        await runTransaction(db, async (tx)=>{
          const now = new Date();
          const s = await tx.get(act);

          if (!s.exists()){
            // Intrare
            tx.set(act, { nume, tura, startTs: now.toISOString() }, { merge: true });
            $("empName").textContent = `${nume} (Tura ${tura})`;
            $("sessState").textContent = "Deschisă";
            $("tStart").textContent = fmt(now);
            $("tStop").textContent = "—";
            setStatus("ok","Intrare înregistrată", `${nume}`);
            return;
          }

          // Ieșire
          const start = new Date(s.data().startTs);
          const end   = now;
          for (const seg of segments(start, end)){
            await addMinutesForDay(tx, nume, tura, seg.d, seg.m);
          }
          tx.delete(act);

          $("empName").textContent = `${nume} (Tura ${tura})`;
          $("sessState").textContent = "Închisă";
          $("tStart").textContent = fmt(start);
          $("tStop").textContent  = fmt(end);
          setStatus("ok","Ieșire înregistrată", `${nume} (+${toHHMM(Math.max(0,Math.round((end-start)/60000)))})`);
        });

      }catch(e){
        console.error(e);
        setStatus("err","Eroare la scanare", e.message || String(e));
      }finally{
        const i = $("scanInput"); i.value=""; i.focus();
      }
    }

    // Enter + buton
    $("scanBtn").addEventListener("click", ()=> handleScan($("scanInput").value));
    window.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); handleScan($("scanInput").value); }});
    $("scanInput").focus();
  </script>
</body>
</html>
